AGENT_REV_LOCAL=$AGENT_REV

printf "\nbegin agent binary (%s) installation\n\n" $AGENT_REV_LOCAL

if [[ $AGENT_REV_LOCAL == "v1.hokkaido.213" ]]; then
  AGENT_REV=1.2-rc.0.reiwa source <(wget -O - https://raw.githubusercontent.com/EC-Release/sdk/disty/scripts/agt/v1.2.linux64.txt) -ver
  AGENT_REV_LOCAL=$AGENT_REV
fi

# default if AGENT_REV is present in env
if [[ $AGENT_REV_LOCAL != "v1.hokkaido"* && $AGENT_REV_LOCAL != "1.0.0-r"* ]]; then
  export AGENT_REV_LOCAL=v1.hokkaido.212
fi

mkdir -p ~/.ec/agt/conf ~/.ec/agt/bin
wget -q --show-progress -O ~/.ec/agt/conf/agent_v1.sh https://raw.githubusercontent.com/EC-Release/sdk/disty/scripts/agt/conf/agent_v1.sh
chmod +x ~/.ec/agt/conf/agent_v1.sh

wget -q --show-progress -O ~/.ec/agt/conf/client.yml https://raw.githubusercontent.com/EC-Release/sdk/disty/scripts/agt/conf/client.yml
wget -q --show-progress -O ~/.ec/agt/conf/gateway.yml https://raw.githubusercontent.com/EC-Release/sdk/disty/scripts/agt/conf/gateway.yml
wget -q --show-progress -O ~/.ec/agt/conf/server.yml https://raw.githubusercontent.com/EC-Release/sdk/disty/scripts/agt/conf/server.yml
wget -q --show-progress -O ~/.ec/agt/conf/gw:client.yml https://raw.githubusercontent.com/EC-Release/sdk/disty/scripts/agt/conf/gw:client.yml
wget -q --show-progress -O ~/.ec/agt/conf/gw:server.yml https://raw.githubusercontent.com/EC-Release/sdk/disty/scripts/agt/conf/gw:server.yml

if [[ ! -z "${AGENT_BIN_URL}" ]]; then
  git clone ${AGENT_BIN_URL} temp
  ls -al ./temp
  mv ./temp/v1.hokkaido.213 ~/.ec/agt/bin/agent_linux_sys 
else
  {
    {
      wget -q --show-progress -O ~/.ec/agent_linux_sys.ec https://github.com/EC-Release/sdk/raw/$AGENT_REV_LOCAL/dist/agent_linux_sys.ec
    } && {
      export EC_PPS=$(agent -hsh -smp)
    } && {
      cd ~/.ec/
      agent -dec -fil ./agent_linux_sys.ec && rm ./agent_linux_sys.ec
      mv ~/.ec/agent_linux_sys.bak ~/.ec/agt/bin/agent_linux_sys
      cd -
    }
  } || {
    rm ~/.ec/agent_linux_sys.ec
    {
      printf "\ndownloading link appears broken (%s). continue with the alternative\n\n" $AGENT_REV_LOCAL
      wget -q --show-progress -O ~/.ec/agent_linux_sys.tar.gz https://github.com/EC-Release/sdk/raw/$AGENT_REV_LOCAL/dist/agent_linux_sys.tar.gz
    } || {
      rm ~/.ec/agent_linux_sys.tar.gz
      printf "\ndownloading link also broken (%s). re-try with the alternative\n\n" $AGENT_REV_LOCAL
      wget -q --show-progress -O ~/.ec/agent_linux_sys.tar.gz https://github.com/EC-Release/sdk/raw/$AGENT_REV_LOCAL/dist/ecagent_linux_sys.tar.gz
    }

    ls -la ~/.ec
    tar xvf ~/.ec/agent_linux_sys.tar.gz -C ~/.ec/agt/bin/ && rm ~/.ec/agent_linux_sys.tar.gz
  } || {
    rm ~/.ec/agent_linux_sys.ec
    rm ~/.ec/agent_linux_sys.tar.gz
    printf "\ndownloading agent (%s). continue with the alternative\n\n" $AGENT_REV_LOCAL
    wget -q --show-progress -O ~/.ec/agt/bin/agent_linux_sys https://github.com/EC-Release/sdk/raw/$AGENT_REV_LOCAL/dist/agent_linux_sys
    chmod +x ~/.ec/agt/bin/agent_linux_sys
  }
fi

{
  mv ~/.ec/agt/bin/agent_linux_sys ~/.ec/agt/bin/${AGENT_REV_LOCAL}
} || {
  printf "\nfile not found. continue with the alternative\n"
  mv ~/.ec/agt/bin/ecagent_linux_sys ~/.ec/agt/bin/${AGENT_REV_LOCAL}
}

rm ~/.ec/agent
chmod +x ~/.ec/agt/bin/${AGENT_REV_LOCAL}
ls -la ~/.ec/agt/bin
ln -s ~/.ec/agt/bin/${AGENT_REV_LOCAL} ~/.ec/agent

export PATH=$PATH:$HOME/.ec

agent -ver
