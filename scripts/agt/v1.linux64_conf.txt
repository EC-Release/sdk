#!/bin/bash

AGENT_REV_LOCAL=$AGENT_REV

if [[ $AGENT_REV_LOCAL == "v1.hokkaido.213" ]]; then
  AGENT_REV=1.2-rc.0.reiwa source <(wget -q -O - https://raw.githubusercontent.com/EC-Release/sdk/disty/scripts/agt/v1.2.linux64.txt) -ver
  AGENT_REV_LOCAL=$AGENT_REV
fi

# default if AGENT_REV is present in env
if [[ $AGENT_REV_LOCAL != "v1.hokkaido"* && $AGENT_REV_LOCAL != "1.0.0-r"* ]]; then
  AGENT_REV_LOCAL=v1.hokkaido.212
fi

printf "\nbegin agt binary (%s) installation\n\n" $AGENT_REV_LOCAL

mkdir -p "$HOME/.ec/agt/conf" "$HOME/.ec/agt/bin"

if [[ ! -z "${AGENT_BIN_URL}" ]]; then
  git clone ${AGENT_BIN_URL} temp &> /dev/null
  #ls -al ./temp
  [[ -f ./temp/v1.hokkaido.213 ]] && mv ./temp/v1.hokkaido.213 "$HOME/agent_linux_sys"
else
  {
    {
      wget -q -O "$HOME/agent_linux_sys.ec" "https://github.com/EC-Release/sdk/raw/$AGENT_REV_LOCAL/dist/agent_linux_sys.ec" &> /dev/null
    } && {
      export EC_PPS=$(agt -hsh -smp)
      agt -dbg -dec -fil "$HOME/agent_linux_sys.ec" && rm "$HOME/agent_linux_sys.ec"      
      [[ -f "$HOME/agent_linux_sys.bak" ]] && mv "$HOME/agent_linux_sys.bak" "$HOME/agent_linux_sys"
    }
  } || {
    rm "$HOME/agent_linux_sys.ec" &> /dev/null
    {
      echo " |_ agt link appears broken ($AGENT_REV_LOCAL). continue with the alternative"
      wget -q -O "$HOME/agent_linux_sys.tar.gz" "https://github.com/EC-Release/sdk/raw/$AGENT_REV_LOCAL/dist/agent_linux_sys.tar.gz" &> /dev/null
    } || {
      rm "$HOME/agent_linux_sys.tar.gz" &> /dev/null
      echo "  |_ agt link also broken ($AGENT_REV_LOCAL). re-try with the alternative"
      wget -q -O "$HOME/agent_linux_sys.tar.gz" "https://github.com/EC-Release/sdk/raw/$AGENT_REV_LOCAL/dist/ecagent_linux_sys.tar.gz" &> /dev/null
    }
    
    tar xvf "$HOME/agent_linux_sys.tar.gz" -C "$HOME/" &> /dev/null && rm "$HOME/agent_linux_sys.tar.gz"
    [[ -f "$HOME/ecagent_linux_sys" ]] && [[ -s "$HOME/ecagent_linux_sys" ]] && mv "$HOME/ecagent_linux_sys" "$HOME/agent_linux_sys"
  } || {
    #"$HOME/agent_linux_sys.ec"
    rm "$HOME/agent_linux_sys.tar.gz" "$HOME/agent_linux_sys" &> /dev/null
    echo "   |_ downloading agt ($AGENT_REV_LOCAL). continue with last attempt"
    wget -q -O "$HOME/agent_linux_sys" "https://github.com/EC-Release/sdk/raw/$AGENT_REV_LOCAL/dist/agent_linux_sys" &> /dev/null
    #chmod +x "$HOME/agent_linux_sys"
  }
fi

if [[ ! -f "$HOME/agent_linux_sys" ]] || [[ ! -s "$HOME/agent_linux_sys" ]]; then
  echo "   |_ failed agt installation\n"
  exit 1
fi

mv "$HOME/agent_linux_sys" "$HOME/.ec/agt/bin/$AGENT_REV_LOCAL"

#[[ -f ~/.ec/agent ]] && rm ~/.ec/agent

chmod +x "$HOME/.ec/agt/bin/$AGENT_REV_LOCAL"

rm /usr/local/bin/agent /usr/local/bin/agt &> /dev/null

ln -s "$HOME/.ec/agt/bin/$AGENT_REV_LOCAL" /usr/local/bin/agent
ln -s "$HOME/.ec/agt/bin/$AGENT_REV_LOCAL" /usr/local/bin/agt

#export PATH=$PATH:$HOME/.ec

source <(wget -q -O - https://raw.githubusercontent.com/EC-Release/sdk/disty/scripts/agt/conf/agent_v1.sh) "$@"
